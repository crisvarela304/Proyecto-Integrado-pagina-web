{% extends "base.html" %}
{% load static %}

{% block title %}Ingreso Masivo de Notas{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 class="mb-1">Ingreso Masivo de Notas</h2>
                            <p class="text-muted mb-0">Curso: <strong>{{ curso }}</strong></p>
                        </div>
                        <div>
                            <a href="{% url 'academico:gestion_cursos' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Volver al Admin
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- Configuración de la Evaluación -->
                        <div class="row g-3 mb-4 p-3 bg-light rounded">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Asignatura</label>
                                <select name="asignatura" class="form-select" required>
                                    <option value="">Seleccione Asignatura...</option>
                                    {% for asignatura in asignaturas %}
                                    <option value="{{ asignatura.id }}" {% if
                                        asignatura.id|slugify==request.POST.asignatura %}selected{% endif %}>
                                        {{ asignatura.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Tipo de Evaluación</label>
                                <select name="tipo_evaluacion" class="form-select" required>
                                    <option value="nota">Nota</option>
                                    <option value="examen">Examen</option>
                                    <option value="tarea">Tarea</option>
                                    <option value="proyecto">Proyecto</option>
                                    <option value="participacion">Participación</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">N° Evaluación</label>
                                <input type="number" name="numero_evaluacion" class="form-control" value="1" min="1"
                                    required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Fecha</label>
                                <input type="date" name="fecha_evaluacion" class="form-control"
                                    value="{% now 'Y-m-d' %}" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descripción (Opcional)</label>
                                <input type="text" name="descripcion" class="form-control"
                                    placeholder="Ej: Prueba de Álgebra">
                            </div>
                        </div>

                        <!-- Lista de Estudiantes -->
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%">#</th>
                                        <th style="width: 40%">Estudiante</th>
                                        <th style="width: 20%">RUT</th>
                                        <th style="width: 15%">Nota (1.0 - 7.0)</th>
                                        <th style="width: 20%">Observación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for estudiante in estudiantes %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <div class="fw-bold">{{ estudiante.get_full_name }}</div>
                                            <small class="text-muted">{{ estudiante.email }}</small>
                                        </td>
                                        <td>{{ estudiante.username }}</td>
                                        <td>
                                            <input type="text" inputmode="decimal" name="nota_{{ estudiante.id }}"
                                                class="form-control nota-input" pattern="^[1-6](\.[0-9])?$|^7(\.0)?$"
                                                maxlength="3" title="Ingresa una nota del 1.0 al 7.0" placeholder="-"
                                                style="width: 100px;">
                                        </td>
                                        <td>
                                            <input type="text" name="obs_{{ estudiante.id }}"
                                                class="form-control form-control-sm" placeholder="Opcional">
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <i class="bi bi-people text-muted fs-1"></i>
                                            <p class="text-muted mt-2">No hay estudiantes activos en este curso.</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if estudiantes %}
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'academico:gestion_cursos' %}"
                                class="btn btn-secondary me-md-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary px-5">
                                <i class="bi bi-save me-2"></i> Guardar Notas
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para validación de notas */
    .nota-input {
        transition: all 0.2s ease;
    }

    .nota-input.is-invalid {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    .nota-input.is-valid {
        border-color: #198754 !important;
        background-color: #f0fff4 !important;
    }

    .nota-input:focus {
        border-color: #3a86ff !important;
        box-shadow: 0 0 0 0.2rem rgba(58, 134, 255, 0.25) !important;
    }
</style>

<script>
    // Validar si un valor es una nota válida (1.0 - 7.0)
    function esNotaValida(valor) {
        if (!valor || valor.trim() === '' || valor === '-') return true;
        const num = parseFloat(valor.replace(',', '.'));
        return !isNaN(num) && num >= 1.0 && num <= 7.0;
    }

    // Formatear nota a formato correcto
    function formatearNota(valor) {
        if (!valor || valor.trim() === '') return '';
        let num = parseFloat(valor.replace(',', '.'));
        if (isNaN(num)) return '';
        num = Math.round(num * 10) / 10;
        if (num < 1.0) num = 1.0;
        if (num > 7.0) num = 7.0;
        return num.toFixed(1);
    }

    // Validar todos los campos de nota
    function validarTodasLasNotas() {
        const inputs = document.querySelectorAll('.nota-input');
        let hayErrores = false;

        inputs.forEach(input => {
            const valor = input.value.trim();
            if (!esNotaValida(valor)) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                hayErrores = true;
            } else if (valor && valor !== '-') {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            } else {
                input.classList.remove('is-invalid', 'is-valid');
            }
        });

        return !hayErrores;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const notaInputs = document.querySelectorAll('.nota-input');

        notaInputs.forEach(input => {
            // Prevenir caracteres no válidos
            input.addEventListener('keypress', function (e) {
                const char = String.fromCharCode(e.which);
                const currentValue = this.value;

                if (!/[0-9.,]/.test(char)) {
                    e.preventDefault();
                    return;
                }

                if ((char === '.' || char === ',') && (currentValue.includes('.') || currentValue.includes(','))) {
                    e.preventDefault();
                    return;
                }

                if (currentValue === '' && !/[1-7]/.test(char)) {
                    e.preventDefault();
                    return;
                }
            });

            // Validar y formatear al perder foco
            input.addEventListener('blur', function () {
                let valor = this.value.trim();

                if (valor && valor !== '-') {
                    const formateado = formatearNota(valor);
                    this.value = formateado;

                    if (!esNotaValida(formateado)) {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    } else {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                }
            });

            // Validar mientras escribe
            input.addEventListener('input', function () {
                const valor = this.value.trim();
                this.classList.remove('is-invalid', 'is-valid');

                if (valor.length === 1 && /[089]/.test(valor)) {
                    this.value = '';
                    this.classList.add('is-invalid');
                }

                const num = parseFloat(valor.replace(',', '.'));
                if (!isNaN(num) && num > 7.0) {
                    this.classList.add('is-invalid');
                }
            });
        });

        // Validar antes de enviar
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (!validarTodasLasNotas()) {
                    e.preventDefault();
                    alert('⚠️ Por favor, corrige las notas marcadas en rojo.\n\nLas notas deben estar entre 1.0 y 7.0');

                    const primerError = document.querySelector('.nota-input.is-invalid');
                    if (primerError) {
                        primerError.focus();
                        primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        }
    });
</script>
{% endblock %}