{% extends 'base.html' %}

{% block title %}Gestión de {{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        {% include 'includes/admin_sidebar.html' %}

        <!-- Contenido -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-people-fill me-2"></i>Gestión de Usuarios</h2>

                <div class="btn-group">
                    {% if tipo_actual == 'estudiante' %}
                    <a href="{% url 'usuarios:matricular_alumno' %}" class="btn btn-primary" title="Inscripción manual">
                        <i class="bi bi-plus-lg"></i> Matrícula Rápida
                    </a>
                    <a href="{% url 'administrativo:carga_masiva_estudiantes' %}"
                        class="btn btn-outline-success ms-2 rounded" title="Importar Excel">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> Importar Alumnos
                    </a>
                    {% endif %}

                    {% if tipo_actual != 'estudiante' and tipo_actual != 'todos' %}
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalCrearUsuario">
                        <i class="bi bi-plus-lg"></i> Nuevo {{ titulo|slice:":-1" }}
                    </button>
                    {% if tipo_actual == 'profesor' %}
                    <a href="{% url 'administrativo:carga_masiva_profesores' %}"
                        class="btn btn-outline-success ms-2 rounded">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> Importar Profesores
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Filtros en Tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link {% if tipo_actual == 'todos' %}active fw-bold{% endif %}"
                        href="?tipo=todos">Todos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if tipo_actual == 'estudiante' %}active fw-bold{% endif %}"
                        href="?tipo=estudiante">Estudiantes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if tipo_actual == 'profesor' %}active fw-bold{% endif %}"
                        href="?tipo=profesor">Profesores</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if tipo_actual == 'administrador' %}active fw-bold{% endif %}"
                        href="?tipo=administrador">Administradores</a>
                </li>
            </ul>

            <!-- Barra de Búsqueda -->
            <div class="card shadow-sm mb-4 border-0 bg-light">
                <div class="card-body py-3">
                    <form method="get" action="." id="filterForm" class="row g-3 align-items-center">
                        <input type="hidden" name="tipo" value="{{ tipo_actual }}">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" name="q" class="form-control border-start-0 ps-0"
                                    placeholder="Buscar por Nombre, RUT, Email o Usuario..." value="{{ q }}">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-secondary w-100">Buscar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla -->
            <div class="card shadow border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Contacto</th>
                                    <th>Estado</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for perfil in page_obj %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-2 rounded-circle d-flex align-items-center justify-content-center"
                                                style="width:40px;height:40px;">
                                                {{ perfil.user.first_name|first }}{{ perfil.user.last_name|first }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ perfil.user.get_full_name }}</div>
                                                <small class="text-muted">{{ perfil.user.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if perfil.user.is_superuser %}
                                        <span class="badge bg-danger">SuperAdmin</span>
                                        {% elif perfil.user.is_staff %}
                                        <span class="badge bg-dark">Admin</span>
                                        {% else %}
                                        {% if perfil.tipo_usuario == 'estudiante' %}
                                        <span class="badge bg-primary">Estudiante</span>
                                        {% elif perfil.tipo_usuario == 'profesor' %}
                                        <span class="badge bg-info text-dark">Profesor</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ perfil.tipo_usuario|title }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>{{ perfil.user.email }}</div>
                                        <small class="text-muted">{{ perfil.rut }}</small>
                                    </td>
                                    <td>
                                        {% if perfil.activo and perfil.user.is_active %}
                                        <span class="badge bg-success-subtle text-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            <!-- Botón Cambio Password -->
                                            <button type="button" class="btn btn-outline-warning"
                                                onclick="abrirModalPassword('{{ perfil.user.id }}', '{{ perfil.user.get_full_name }}')"
                                                title="Cambiar Contraseña">
                                                <i class="bi bi-key-fill"></i>
                                            </button>

                                            <a href="{% url 'usuarios:editar_usuario' perfil.user.id %}"
                                                class="btn btn-outline-secondary" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% if perfil.tipo_usuario == 'estudiante' %}
                                            <a href="{% url 'academico:detalle_estudiante' perfil.user.id %}"
                                                class="btn btn-outline-info" title="Ver Académico">
                                                <i class="bi bi-mortarboard"></i>
                                            </a>
                                            {% endif %}

                                            {% if user.is_superuser and not perfil.user.is_superuser %}
                                            <!-- Botón Eliminar Usuario -->
                                            <button type="button" class="btn btn-outline-danger"
                                                onclick="confirmarEliminar('{{ perfil.user.id }}', '{{ perfil.user.get_full_name }}')"
                                                title="Eliminar Usuario">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        <i class="bi bi-search fs-1 mb-2 d-block opacity-25"></i>
                                        No se encontraron usuarios con los filtres actuales.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <div class="card-footer bg-white d-flex justify-content-end p-3">
                    <nav>
                        <ul class="pagination mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item"><a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&tipo={{ tipo_actual }}&q={{ q }}">&laquo;</a>
                            </li>
                            {% endif %}

                            <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>

                            {% if page_obj.has_next %}
                            <li class="page-item"><a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&tipo={{ tipo_actual }}&q={{ q }}">&raquo;</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>

            <!-- Modal Crear Usuario Genérico -->
            <div class="modal fade" id="modalCrearUsuario" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="{% url 'usuarios:crear_usuario_rapido' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="tipo_usuario" value="{{ tipo_actual }}">

                            <div class="modal-header">
                                <h5 class="modal-title fw-bold">Nuevo {{ titulo|slice:":-1" }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info py-2 small">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Se creará un usuario y perfil de <strong>{{ titulo|slice:":-1" }}</strong>.
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">RUT</label>
                                        <input type="text" name="rut" class="form-control" placeholder="12.345.678-9"
                                            required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email (Opcional)</label>
                                        <input type="email" name="email" class="form-control"
                                            placeholder="nombre@liceo.cl">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Nombres</label>
                                        <input type="text" name="first_name" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Apellidos</label>
                                        <input type="text" name="last_name" class="form-control" required>
                                    </div>

                                    <div class="col-12">
                                        <hr class="my-1">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Contraseña</label>
                                        <input type="password" name="password1" class="form-control"
                                            placeholder="Mínimo 6 caracteres" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Confirmar Contraseña</label>
                                        <input type="password" name="password2" class="form-control"
                                            placeholder="Repetir contraseña" required>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Crear Usuario</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Cambio de Password -->
            <div class="modal fade" id="modalPassword" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content shadow">
                        <form action="{% url 'usuarios:admin_reset_password' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" id="pass_user_id">
                            <input type="hidden" name="current_type" value="{{ tipo_actual }}">

                            <div class="modal-header bg-warning bg-opacity-10">
                                <h5 class="modal-title fw-bold text-dark">
                                    <i class="bi bi-key-fill text-warning me-2"></i>Cambiar Contraseña
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Estás cambiando la contraseña para el usuario: <strong
                                        id="pass_user_name" class="text-primary"></strong></p>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nueva Contraseña</label>
                                    <div class="input-group">
                                        <input type="text" name="new_password" id="new_password_input"
                                            class="form-control font-monospace" required minlength="6"
                                            placeholder="Escribe o genera una...">
                                        <button class="btn btn-outline-primary" type="button"
                                            onclick="generarPassword()">
                                            <i class="bi bi-shuffle"></i> Generar
                                        </button>
                                    </div>
                                    <div class="form-text">Mínimo 6 caracteres. Se recomienda usar el generador.</div>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary px-4 fw-bold">Guardar Nueva
                                    Contraseña</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Confirmar Eliminación -->
            <div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content shadow">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title fw-bold">
                                <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger py-2">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                <strong>¡Atención!</strong> Esta acción no se puede deshacer.
                            </div>
                            <p>¿Estás seguro de que deseas eliminar al usuario <strong id="delete_user_name"
                                    class="text-danger"></strong>?</p>
                            <p class="text-muted small mb-0">Se eliminarán todos sus datos asociados: perfil, notas,
                                asistencias, mensajes, etc.</p>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <a href="#" id="delete_confirm_btn" class="btn btn-danger px-4 fw-bold">
                                <i class="bi bi-trash me-1"></i>Eliminar Permanentemente
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<script>
    function abrirModalPassword(userId, userName) {
        document.getElementById('pass_user_id').value = userId;
        document.getElementById('pass_user_name').textContent = userName;
        document.getElementById('new_password_input').value = ''; // Limpiar anterior

        var myModal = new bootstrap.Modal(document.getElementById('modalPassword'));
        myModal.show();
    }

    function generarPassword() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%";
        const length = 12;
        let password = "";
        for (let i = 0; i < length; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('new_password_input').value = password;
    }

    function confirmarEliminar(userId, userName) {
        document.getElementById('delete_user_name').textContent = userName;
        document.getElementById('delete_confirm_btn').href = "{% url 'usuarios:eliminar_usuario' 0 %}".replace('/0/', '/' + userId + '/');

        var myModal = new bootstrap.Modal(document.getElementById('modalEliminar'));
        myModal.show();
    }
</script>
{% endblock %}